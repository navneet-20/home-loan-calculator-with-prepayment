<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>The Ultimate Home Loan Savings & Prepayment Analyzer</title>
    <!-- SEO Metadata -->
    <meta name="description" content="Advanced home loan EMI calculator and saving analyzer. Calculate monthly payments, analyze prepayments, and see interest savings when reducing tenure or EMI.">
    <meta name="keywords" content="Home Loan Calculator, Advance Home Loan Calculator, Home Loan Calculator with Prepayment, Home Loan Tax Saving Calculator, EMI Calculator, Loan Amortization Schedule, Loan Repayment Analyzer, Prepayment Savings, Reduce Loan Tenure, Reduce Monthly EMI, financial calculator, India loan calculator">
    <meta name="author" content="Loan Analyzer App">
    
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Use Inter font family -->
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f7fafc;
        }
        /* Increased responsiveness for the table container */
        .scrollable-table {
            max-height: 500px;
            overflow-x: auto; /* Allows horizontal scrolling for the wide table on small screens */
            overflow-y: auto;
        }
        /* Fixed width for table content on mobile to prevent stretching */
        .min-w-full {
             min-width: 800px; /* Ensure table columns have space, allowing container to scroll */
        }
        /* Custom Tailwind class for input group */
        .input-group {
            @apply flex rounded-lg shadow-sm;
        }
        .input-unit {
            @apply inline-flex items-center px-3 text-sm text-gray-500 bg-gray-50 border border-l-0 border-gray-300 rounded-r-lg;
        }
        .input-field-group {
            /* Applied to the input inside the group, rounded-l-lg */
            @apply w-full p-3 border border-gray-300 rounded-l-lg focus:ring-blue-500 focus:border-blue-500 transition duration-150;
        }
    </style>
</head>
<body class="p-4 sm:p-8">

    <div class="max-w-6xl mx-auto bg-white shadow-2xl rounded-xl p-6 lg:p-10 border border-gray-100">
        <h1 class="text-3xl sm:text-4xl lg:text-5xl font-extrabold text-blue-800 mb-6 text-center">
            The Ultimate Home Loan Savings & Prepayment Analyzer
        </h1>

        <!-- Input Section -->
        <!-- Adjusted grid for better mobile stacking (4 columns on large screens, 2 on medium, 1 on small) -->
        <div id="input-section" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4 mb-8 p-4 border border-blue-200 rounded-lg bg-blue-50">
            <div class="col-span-full text-lg font-semibold text-blue-700 mb-2">Loan Details (Up to 25 Years)</div>

            <!-- Principal Input Group -->
            <div class="flex flex-col">
                <label for="principal" class="text-sm font-medium text-gray-700 mb-1">Total Principal</label>
                <div class="input-group">
                    <input type="number" id="principal" placeholder="50,00,000" value="5000000" class="input-field-group border-r-0" required min="1000">
                    <span class="input-unit border-l-0">â‚¹</span>
                </div>
            </div>

            <!-- Interest Rate Input Group -->
            <div class="flex flex-col">
                <label for="rate" class="text-sm font-medium text-gray-700 mb-1">Interest Rate</label>
                <div class="input-group">
                    <input type="number" id="rate" placeholder="8.5" value="8.5" step="0.01" class="input-field-group border-r-0" required min="0.1" max="50">
                    <span class="input-unit border-l-0">%</span>
                </div>
            </div>
            
            <!-- Tenure Input Group -->
            <div class="flex flex-col">
                <label for="tenure" class="text-sm font-medium text-gray-700 mb-1">Loan Tenure</label>
                <div class="input-group">
                    <input type="number" id="tenure" placeholder="20" value="20" class="input-field-group border-r-0" required min="1" max="25">
                    <span class="input-unit border-l-0">Years</span>
                </div>
            </div>
            
            <!-- START MONTH INPUT: Replaced type="month" with two selects -->
            <div class="flex flex-col">
                <label class="text-sm font-medium text-gray-700 mb-1">Loan Start Month</label>
                <div class="flex gap-2">
                    <select id="start-month" class="input-field w-1/2" required></select>
                    <select id="start-year" class="input-field w-1/2" required></select>
                </div>
            </div>
            <!-- END START MONTH INPUT -->

            <button onclick="calculateLoan()" id="calculate-btn" class="col-span-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 rounded-lg transition duration-200 shadow-md">
                Proceed
            </button>
        </div>

        <!-- Results Summary Section -->
        <!-- Ensure summary cards stack nicely on mobile -->
        <div id="summary-section" class="hidden mb-8 grid grid-cols-1 sm:grid-cols-3 gap-4">
            <!-- Initial EMI -->
            <div class="summary-card bg-indigo-50 border-indigo-300">
                <p class="text-sm font-medium text-indigo-700">Initial Monthly EMI</p>
                <p id="initial-emi-output" class="text-2xl font-bold text-indigo-900"></p>
            </div>
            <!-- Total Interest Payable -->
            <div class="summary-card bg-red-50 border-red-300">
                <p class="text-sm font-medium text-red-700">Total Interest Payable</p>
                <p id="initial-interest-output" class="text-2xl font-bold text-red-900"></p>
            </div>
            <!-- Total Loan Duration -->
            <div class="summary-card bg-gray-50 border-gray-300">
                <p class="text-sm font-medium text-gray-700">Original Duration</p>
                <p id="original-duration-output" class="text-2xl font-bold text-gray-900"></p>
            </div>
        </div>

        <!-- Prepayment Section -->
        <div id="prepayment-container" class="hidden p-6 border border-green-300 rounded-lg bg-green-50 mb-8">
            <h2 class="text-2xl font-semibold text-green-800 mb-4">Add Prepayments</h2>

            <!-- Reduction Option (Moved above Prepayment Frequency) -->
            <div class="mb-6">
                <label for="reduction-option" class="block text-sm font-medium text-gray-700 mb-1">After Prepayment, Reduce:</label>
                <!-- ADDED onchange="updatePrepaymentOptions()" -->
                <select id="reduction-option" class="input-field" onchange="updatePrepaymentOptions()">
                    <option value="tenure">Loan Tenure (Recommended for max savings)</option>
                    <option value="emi">Monthly EMI</option>
                </select>
            </div>
            <!-- Ensure prepayment controls stack on small screens -->
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
                <!-- Prepayment Frequency -->
                <div>
                    <label for="prepayment-type" class="block text-sm font-medium text-gray-700 mb-1">Prepayment Frequency</label>
                    <select id="prepayment-type" onchange="updatePrepaymentInputs()" class="input-field">
                        <option value="none">No Prepayment</option>
                        <option value="monthly">Monthly (Regular)</option>
                        <option value="quarterly">Quarterly (Regular)</option>
                        <option value="six-monthly">Six-Monthly (Regular)</option>
                        <option value="yearly">Yearly (Regular)</option>
                        <option value="one-time">One Time Lump Sum</option>
                        <option value="custom">On Particular Months (Custom Schedule)</option>
                    </select>
                </div>

                <!-- Prepayment Amount (for regular and one-time) -->
                <!-- RE-ENABLED/VISIBILITY FOR ALL NON-CUSTOM OPTIONS -->
                <div id="prepayment-amount-div">
                    <label for="prepayment-amount" class="block text-sm font-medium text-gray-700 mb-1">Prepayment Amount (in addition to EMI)</label>
                    <input type="number" id="prepayment-amount" placeholder="Amount (e.g., 50000)" class="input-field" min="0" value="0">
                </div>

                <!-- Custom Month Input (NEW Dynamic UI) -->
                <!-- This section is only shown when 'Custom Schedule' is selected -->
                <div id="custom-months-div" class="col-span-1 md:col-span-2 hidden p-4 border border-green-200 rounded-lg bg-green-100">
                    <label class="block text-sm font-medium text-green-800 mb-2">Custom Prepayment Entry</label>
                    
                    <!-- Replaced type="month" with two selects for Custom Prepayment -->
                    <div class="grid grid-cols-1 sm:grid-cols-4 gap-3">
                        <select id="custom-payment-month" class="input-field col-span-1 sm:col-span-1" required></select>
                        <select id="custom-payment-year" class="input-field col-span-1 sm:col-span-1" required></select>
                        <input type="number" id="custom-payment-amount" placeholder="Amount" class="input-field col-span-1 sm:col-span-1" min="1" required>
                        <button onclick="addCustomPayment()" class="bg-green-500 hover:bg-green-600 text-white font-semibold py-2 rounded-lg transition duration-200 col-span-1 sm:col-span-1">
                            Add Payment
                        </button>
                    </div>

                    <div class="mt-4">
                        <p class="text-sm font-medium text-gray-700 mb-2">Current Custom Payments:</p>
                        <div id="custom-payments-list" class="max-h-32 overflow-y-auto space-y-2">
                            <!-- Payments will be listed here -->
                            <p id="custom-payments-placeholder" class="text-gray-500 text-sm italic">No custom payments added yet. Please calculate the loan first.</p>
                        </div>
                    </div>
                </div>
            </div>

            <button onclick="applyPrepayments()" class="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-3 rounded-lg transition duration-200 shadow-lg">
                Apply Prepayments & See Savings
            </button>
        </div>

        <!-- Savings Summary Section -->
        <!-- Ensure savings summary stacks nicely on mobile -->
        <div id="savings-summary" class="hidden mb-8 p-6 border-l-4 border-yellow-500 bg-yellow-50 rounded-lg shadow-inner">
            <h2 class="text-2xl font-semibold text-yellow-800 mb-4">ðŸ’° Prepayment Savings Analysis</h2>
            <div class="grid grid-cols-1 sm:grid-cols-3 gap-4">
                <div>
                    <p class="text-sm font-medium text-yellow-700">Total Interest Saved</p>
                    <p id="saved-interest-output" class="text-2xl font-bold text-yellow-900"></p>
                </div>
                <div>
                    <p class="text-sm font-medium text-yellow-700">New Loan Duration</p>
                    <p id="new-duration-output" class="text-2xl font-bold text-yellow-900"></p>
                </div>
                <div>
                    <p class="text-sm font-medium text-yellow-700">Reduction in Tenure</p>
                    <p id="tenure-reduction-output" class="text-2xl font-bold text-yellow-900"></p>
                </div>
            </div>
            <p id="new-emi-info" class="mt-4 text-md font-medium text-yellow-800"></p>
        </div>

        <!-- Schedule Section -->
        <div id="schedule-section" class="hidden mt-8">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-2xl font-semibold text-gray-800">Monthly Loan Repayment Schedule</h2>
                <button onclick="exportTableToCSV('loan_schedule.csv')" class="bg-indigo-500 hover:bg-indigo-600 text-white font-semibold py-2 px-4 rounded-lg transition duration-200 shadow-md flex items-center">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" viewBox="0 0 20 20" fill="currentColor">
                        <path fill-rule="evenodd" d="M3 17a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zm3.293-7.707a1 1 0 011.414 0L9 10.586V3a1 1 0 112 0v7.586l1.293-1.293a1 1 0 111.414 1.414l-3 3a1 1 0 01-1.414 0l-3-3a1 1 0 010-1.414z" clip-rule="evenodd" />
                    </svg>
                    Export to CSV/Excel
                </button>
            </div>
            <div class="scrollable-table shadow-lg rounded-lg">
                <!-- Added min-w-full class to force the table to be wide enough to be scrollable -->
                <table class="min-w-full divide-y divide-gray-200" id="loan-schedule-table">
                    <thead class="bg-gray-50 sticky top-0 z-10">
                        <tr>
                            <th class="table-header">Month</th>
                            <th class="table-header">Date</th>
                            <th class="table-header">EMI</th>
                            <th class="table-header">Prepayment</th>
                            <th class="table-header">Towards Principal</th>
                            <th class="table-header">Towards Interest</th>
                            <th class="table-header">Outstanding Principal</th>
                        </tr>
                    </thead>
                    <tbody id="schedule-body" class="bg-white divide-y divide-gray-200 text-sm">
                        <!-- Schedule rows will be inserted here -->
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Alert/Error Message Box -->
        <div id="message-box" class="fixed inset-0 bg-gray-600 bg-opacity-50 flex items-center justify-center z-50 hidden" onclick="hideMessage()">
            <div class="bg-white p-6 rounded-lg shadow-2xl max-w-sm w-full" onclick="event.stopPropagation()">
                <h3 id="message-title" class="text-xl font-bold mb-3 text-red-600">Error</h3>
                <p id="message-text" class="text-gray-700 mb-4">An error occurred.</p>
                <button onclick="hideMessage()" class="w-full bg-red-500 hover:bg-red-600 text-white font-bold py-2 rounded-lg transition duration-200">
                    Close
                </button>
            </div>
        </div>
    </div>

    <script>
        // Global variables for configuration and state
        let initialPrincipal = 0;
        let initialRate = 0; // Annual rate percentage
        let initialTenureMonths = 0;
        let initialEMI = 0;
        let initialTotalInterest = 0;
        let initialTotalPayments = 0;
        let loanStartDateString = ''; // YYYY-MM string for the loan start date
        
        // Storage for custom prepayments: Array of { monthIndex: number, date: string, amount: number }
        let customPayments = [];Â 

        // Currency format set to minimumFractionDigits: 0 (nearest Rupee)
        const CURRENCY_FORMAT = new Intl.NumberFormat('en-IN', { style: 'currency', currency: 'INR', minimumFractionDigits: 0 });

        /**
         * Helper function to round monetary values to the nearest whole number (Rupee).
         * This is used in calculations to prevent floating-point errors and keep numbers clean.
         * @param {number} num - The number to round.
         * @returns {number} The rounded number.
         */
        const roundToRupee = (num) => Math.round(num);


        // --- Utility Functions ---

        /**
         * Custom alert box replacement.
         * @param {string} title - Title of the message box.
         * @param {string} message - Content of the message.
         * @param {string} type - 'success', 'error', 'warning' for styling.
         */
        function showMessage(title, message, type = 'error') {
            const box = document.getElementById('message-box');
            const titleEl = document.getElementById('message-title');
            const textEl = document.getElementById('message-text');
            const buttonEl = box.querySelector('button');

            titleEl.textContent = title;
            textEl.textContent = message;

            // Apply colors based on type
            let titleColor = 'text-red-600';
            let buttonColor = 'bg-red-500 hover:bg-red-600';

            if (type === 'success') {
                titleColor = 'text-green-600';
                buttonColor = 'bg-green-500 hover:bg-green-600';
            } else if (type === 'warning') {
                titleColor = 'text-yellow-600';
                buttonColor = 'bg-yellow-500 hover:bg-yellow-600';
            }

            titleEl.className = `text-xl font-bold mb-3 ${titleColor}`;
            buttonEl.className = `w-full ${buttonColor} text-white font-bold py-2 rounded-lg transition duration-200`;
            
            box.classList.remove('hidden');
        }

        function hideMessage() {
            document.getElementById('message-box').classList.add('hidden');
        }

        /**
         * Calculates the EMI for a loan.
         * @param {number} P - Principal loan amount.
         * @param {number} r - Monthly interest rate (decimal).
         * @param {number} n - Total number of months.
         * @returns {number} The monthly EMI amount.
         */
        function calculateEMI(P, r, n) {
            if (r === 0) {
                return P / n;
            }
            // EMI = P * [r * (1 + r)^n] / [(1 + r)^n - 1]
            return P * r * Math.pow(1 + r, n) / (Math.pow(1 + r, n) - 1);
        }

        /**
         * Converts a prepayment date (YYYY-MM) into a 1-based month index relative to the loan start date.
         * @param {string} prepaymentDateString - YYYY-MM string of the prepayment.
         * @param {string} loanStartDateString - YYYY-MM string of the loan start.
         * @returns {number} The 1-based month index (e.g., 1 for the first payment month).
         */
        function getMonthIndexFromDate(prepaymentDateString, loanStartDateString) {
            const [pYear, pMonth] = prepaymentDateString.split('-').map(Number);
            const [sYear, sMonth] = loanStartDateString.split('-').map(Number);
            
            // Months elapsed since loan start (0-based)
            const monthsElapsed = (pYear - sYear) * 12 + (pMonth - sMonth);
            
            // Month index is 1-based
            return monthsElapsed + 1;
        }

        /**
         * Gets the date for a given month index in the loan.
         * @param {number} monthIndex - 1-based index (1 for the first payment).
         * @param {string} startDateString - YYYY-MM string from the input.
         * @returns {string} Formatted date string (e.g., "Oct 2025").
         */
        function getDateForMonth(monthIndex, startDateString) {
            const [yearStr, monthStr] = startDateString.split('-');
            let startYear = parseInt(yearStr);
            let startMonth = parseInt(monthStr); // 1-12

            // Calculate the target month and year
            let targetMonth = startMonth + monthIndex - 1;
            let targetYear = startYear + Math.floor((targetMonth - 1) / 12);
            targetMonth = ((targetMonth - 1) % 12) + 1; // Normalize to 1-12

            const date = new Date(targetYear, targetMonth - 1);
            return date.toLocaleString('en-US', { month: 'short', year: 'numeric' });
        }
        
        /**
         * Converts the HTML table data into a CSV string and downloads it.
         * @param {string} filename - The name for the downloaded file.
         */
        function exportTableToCSV(filename) {
            const table = document.getElementById('loan-schedule-table');
            if (!table) {
                showMessage('Export Error', 'Loan schedule table not found.', 'error');
                return;
            }

            const rows = table.querySelectorAll('tr');
            let csv = [];

            // 1. Get Table Headers (Thead)
            const headerCells = table.querySelectorAll('thead th');
            const header = Array.from(headerCells).map(th => `"${th.textContent.trim()}"`).join(',');
            csv.push(header);

            // 2. Get Table Body Rows (Tbody)
            const bodyRows = table.querySelectorAll('tbody tr');
            bodyRows.forEach(row => {
                const rowData = [];
                // Get all cells (td) in the row
                const cells = row.querySelectorAll('td');

                cells.forEach(cell => {
                    // Extract text content, remove non-numeric characters (like â‚¹ or ,)Â 
                    // and handle special indicators like "(New)" for clean numbers
                    let content = cell.textContent.trim();
                    
                    // Remove currency symbols, commas, and formatting tags like '(New)'
                    content = content.replace(/â‚¹/g, '').replace(/,/g, '').replace(/\(New\)/g, '').trim();

                    // Replace non-breaking spaces if any
                    content = content.replace(/\s+/g, ' ');Â 
                    
                    // Enclose content in quotes to handle dates/text fields
                    rowData.push(`"${content}"`);
                });
                csv.push(rowData.join(','));
            });

            // If no data was exported (only headers), throw a warning
            if (csv.length <= 1) {
                 showMessage('Export Warning', 'The loan schedule is empty. Please calculate the loan first before exporting.', 'warning');
                 return;
            }

            // 3. Create Blob and Trigger Download
            const csvFile = csv.join('\n');
            const blob = new Blob([csvFile], { type: 'text/csv;charset=utf-8;' });
            
            // Use a temporary anchor element to trigger the download
            const link = document.createElement("a");
            if (link.download !== undefined) {Â 
                const url = URL.createObjectURL(blob);
                link.setAttribute("href", url);
                link.setAttribute("download", filename);
                link.style.visibility = 'hidden';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            }
        }
        
        /**
         * Helper function to get the current YYYY-MM string from the Loan Start Month selects.
         */
        function getLoanStartDateString() {
            const month = document.getElementById('start-month').value;
            const year = document.getElementById('start-year').value;
            if (month && year) {
                return `${year}-${month}`;
            }
            return null;
        }

        // --- Core Calculation Logic ---

        /**
         * Generates the amortization schedule up to a maximum number of payments (months).
         */
        function generateAmortizationSchedule(principal, monthlyRate, emi, maxMonths, prepayments = {}) {
            let outstanding = principal;
            let totalInterest = 0;
            let totalPayments = 0;
            let schedule = [];

            for (let monthIndex = 1; monthIndex <= maxMonths; monthIndex++) {
                if (outstanding <= 0) break;

                // 1. Calculate Interest for the month and round it to the nearest rupee
                let interest = outstanding * monthlyRate;
                interest = roundToRupee(interest);

                // 2. Determine Prepayment amount
                const prepayment = prepayments[monthIndex] || 0;

                // 3. Determine total payment (EMI + Prepayment)
                let payment = emi + prepayment;

                // If remaining outstanding is less than (EMI + interest), final payment is capped
                let principalPaid, interestPaid, outstandingEnd;
                
                if (outstanding + interest <= payment) {
                    payment = outstanding + interest;
                    principalPaid = outstanding;Â 
                    interestPaid = interest;Â 
                    outstandingEnd = 0;
                } else {
                    interestPaid = interest;
                    principalPaid = payment - interest;
                    outstandingEnd = outstanding - principalPaid;
                }
                
                // If principalPaid becomes negative, adjust for safety (shouldn't happen with correct EMI)
                if (principalPaid < 0) {
                    principalPaid = 0;
                    outstandingEnd = outstanding;
                    if (emi < interest && principal > 0) { // Only show error if loan hasn't paid off
                        showMessage('Loan Calculation Error', `The calculated EMI (${CURRENCY_FORMAT.format(emi)}) is less than the current month's interest (${CURRENCY_FORMAT.format(interest)}). Please check your Rate or Principal.`);
                        return { schedule: [], totalInterest: 0, totalPayments: 0 };
                    }
                }

                // Final rounding of the monthly principal and new outstanding balance
                principalPaid = roundToRupee(principalPaid);
                // Ensure outstanding end calculation uses the rounded principal paid
                outstandingEnd = roundToRupee(outstanding - principalPaid);Â 
                
                // Handle the case where the rounding caused a slight overshoot/undershoot on the final payment
                if (outstandingEnd < 0) outstandingEnd = 0;


                schedule.push({
                    month: monthIndex,
                    emi: emi,
                    prepayment: prepayment,
                    principal: principalPaid,
                    interest: interestPaid,
                    outstanding: outstandingEnd,
                    isPrepaymentMonth: prepayment > 0,
                });

                totalInterest += interestPaid;
                totalPayments = monthIndex;
                outstanding = outstandingEnd;

                // If the loan is paid off, stop.
                if (outstandingEnd <= 0) break;
            }

            // Round final total interest for cleaner output
            totalInterest = roundToRupee(totalInterest);

            return { schedule, totalInterest, totalPayments };
        }

        // --- UI Event Handlers (Prepayment) ---

        /**
         * Dynamically updates the available prepayment types based on the selected reduction option.
         */
        function updatePrepaymentOptions() {
            const reductionOption = document.getElementById('reduction-option').value;
            const prepaymentSelect = document.getElementById('prepayment-type');
            
            // These options are disabled/hidden for EMI reduction, as they usually reduce tenure by default
            const periodicOptions = ['monthly', 'quarterly', 'six-monthly', 'yearly'];

            let shouldResetSelection = false;
            const currentSelection = prepaymentSelect.value;

            prepaymentSelect.querySelectorAll('option').forEach(option => {
                const isPeriodic = periodicOptions.includes(option.value);

                if (reductionOption === 'emi') {
                    // In EMI reduction mode, disable periodic options
                    if (isPeriodic) {
                        option.disabled = true;
                        option.hidden = true;
                        if (option.value === currentSelection) {
                            shouldResetSelection = true;
                        }
                    } else {
                        option.disabled = false;
                        option.hidden = false;
                    }
                } else {
                    // In Tenure reduction mode, enable all options
                    option.disabled = false;
                    option.hidden = false;
                }
            });

            if (shouldResetSelection) {
                // If a newly disabled option was selected, fall back to "none"
                prepaymentSelect.value = 'none';
            }
            // Always call updatePrepaymentInputs to ensure the amount/custom inputs reflect the final selection
            updatePrepaymentInputs(); 
        }

        /**
         * FIX: Update to only show the single amount field for all options EXCEPT 'custom'
         */
        function updatePrepaymentInputs() {
            const type = document.getElementById('prepayment-type').value;
            const amountDiv = document.getElementById('prepayment-amount-div');
            const customDiv = document.getElementById('custom-months-div');
            const amountInput = document.getElementById('prepayment-amount');

            // Determine if we should show the single amount input (all except 'custom')
            const isSingleAmount = (type !== 'custom' && type !== 'none');
            
            // Show/Hide controls based on type
            amountDiv.classList.toggle('hidden', type === 'custom' || type === 'none');
            customDiv.classList.toggle('hidden', type !== 'custom');

            // Update label for single amount input based on frequency
            if (type === 'one-time') {
                amountDiv.querySelector('label').textContent = 'One-Time Lump Sum Amount';
                // Show date selectors only for one-time payment type
                showOneTimeDateSelectors(true);
            } else if (isSingleAmount) {
                amountDiv.querySelector('label').textContent = 'Prepayment Amount (in addition to EMI)';
                // Hide date selectors for periodic payments
                showOneTimeDateSelectors(false);
            } else {
                // If 'none' or 'custom' is selected, hide date selectors
                showOneTimeDateSelectors(false);
            }
        }
        
        /**
         * Manages the visibility of the one-time date selectors within the amount div.
         * @param {boolean} show - Whether to show or hide the date selectors.
         */
        function showOneTimeDateSelectors(show) {
            const amountDiv = document.getElementById('prepayment-amount-div');
            let wrapper = document.getElementById('one-time-date-wrapper');

            if (show) {
                if (!wrapper) {
                    wrapper = document.createElement('div');
                    wrapper.id = 'one-time-date-wrapper';
                    wrapper.className = 'flex gap-2 mt-2';

                    const monthInput = document.createElement('select');
                    monthInput.id = 'one-time-month-input';
                    monthInput.className = 'input-field w-1/2';
                    monthInput.required = true;

                    const yearInput = document.createElement('select');
                    yearInput.id = 'one-time-year-input';
                    yearInput.className = 'input-field w-1/2';
                    yearInput.required = true;

                    wrapper.appendChild(monthInput);
                    wrapper.appendChild(yearInput);
                    amountDiv.appendChild(wrapper);

                    // Repopulate month/year options
                    populateMonthYearSelects(monthInput, yearInput);

                    // Set default to loan start date if available
                    if (loanStartDateString) {
                        const [year, month] = loanStartDateString.split('-');
                        monthInput.value = month;
                        yearInput.value = year;
                    } else {
                        const today = new Date();
                        monthInput.value = String(today.getMonth() + 1).padStart(2, '0');
                        yearInput.value = today.getFullYear();
                    }
                }
                wrapper.classList.remove('hidden');
            } else {
                if (wrapper) {
                    wrapper.classList.add('hidden');
                }
            }
        }


        /**
         * Helper function to get the current YYYY-MM string from the Custom Prepayment selects.
         */
        function getCustomPaymentDateString() {
            const month = document.getElementById('custom-payment-month').value;
            const year = document.getElementById('custom-payment-year').value;
            if (month && year) {
                return `${year}-${month}`;
            }
            return null;
        }

        /**
         * Adds a custom prepayment (date + amount) to the global list.
         */
        function addCustomPayment() {
            const prepaymentDateString = getCustomPaymentDateString();
            const prepaymentAmount = parseFloat(document.getElementById('custom-payment-amount').value);
            
            if (!loanStartDateString) {
                showMessage('Error', 'Please calculate the initial loan first to set the loan start date.', 'error');
                return;
            }

            if (!prepaymentDateString || !prepaymentAmount || prepaymentAmount <= 0 || isNaN(prepaymentAmount)) {
                showMessage('Missing Data', 'Please select a Month/Year and enter a valid positive Amount.', 'error');
                return;
            }
            
            const monthIndex = getMonthIndexFromDate(prepaymentDateString, loanStartDateString);
            
            if (monthIndex < 1) {
                showMessage('Date Error', 'The prepayment date must be in or after the loan start month (' + getDateForMonth(1, loanStartDateString) + ').', 'error');
                return;
            }
            
            // Max month index is based on 25 years (300 months)
            if (monthIndex > 300) {
                 showMessage('Date Warning', 'The selected month is beyond the maximum 25-year tenure (300 months) typically supported. It will be ignored if the loan is paid off before then.', 'warning');
            }


            // Add or merge the payment
            const existingPaymentIndex = customPayments.findIndex(p => p.monthIndex === monthIndex);

            if (existingPaymentIndex !== -1) {
                customPayments[existingPaymentIndex].amount += roundToRupee(prepaymentAmount); // Round input on merge
            } else {
                customPayments.push({
                    monthIndex: monthIndex,
                    date: prepaymentDateString, // Store as YYYY-MM
                    amount: roundToRupee(prepaymentAmount), // Round input on creation
                });
                // Sort by month index to ensure easy review
                customPayments.sort((a, b) => a.monthIndex - b.monthIndex);
            }
            
            // Clear inputs and refresh list
            document.getElementById('custom-payment-amount').value = '';
            renderCustomPaymentsList();
        }

        /**
         * Removes a custom prepayment from the list.
         * @param {number} monthIndex - The 1-based month index of the payment to remove.
         */
        function removeCustomPayment(monthIndex) {
            customPayments = customPayments.filter(p => p.monthIndex !== monthIndex);
            renderCustomPaymentsList();
        }

        /**
         * Renders the list of custom payments in the UI.
         */
        function renderCustomPaymentsList() {
            const listEl = document.getElementById('custom-payments-list');
            listEl.innerHTML = '';

            if (customPayments.length === 0) {
                listEl.innerHTML = '<p id="custom-payments-placeholder" class="text-gray-500 text-sm italic">No custom payments added yet.</p>';
                return;
            }

            customPayments.forEach(p => {
                const dateDisplay = getDateForMonth(p.monthIndex, loanStartDateString);

                const item = document.createElement('div');
                item.className = 'flex justify-between items-center p-2 bg-white rounded-md shadow-sm border border-gray-200';
                item.innerHTML = `
                    <span class="text-sm font-medium text-gray-800">${dateDisplay} (Month ${p.monthIndex}):</span>
                    <span class="text-sm font-bold text-green-700">${CURRENCY_FORMAT.format(p.amount)}</span>
                    <button onclick="removeCustomPayment(${p.monthIndex})" class="text-red-500 hover:text-red-700 transition duration-150 p-1 rounded-full hover:bg-red-100">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor">
                            <path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm4 0a1 1 0 10-2 0v6a1 1 0 102 0V8z" clip-rule="evenodd" />
                        </svg>
                    </button>
                `;
                listEl.appendChild(item);
            });
        }


        /**
         * Primary function to calculate the initial loan and display the schedule.
         * FIX: Added reset logic to clear prepayment fields.
         */
        function calculateLoan() {
            const principal = parseFloat(document.getElementById('principal').value);
            const ratePercent = parseFloat(document.getElementById('rate').value);
            const tenureYears = parseFloat(document.getElementById('tenure').value);
            const startDateString = getLoanStartDateString(); // Get YYYY-MM string from selects

            // Input Validation
            if (!principal || !ratePercent || !tenureYears || !startDateString) {
                showMessage('Missing Information', 'Please fill in the Principal, Interest Rate, Tenure, and Loan Start Month/Year.', 'error');
                return;
            }
            if (tenureYears > 25) {
                showMessage('Maximum Tenure Exceeded', 'The maximum supported loan tenure is 25 years.', 'warning');
                return;
            }
            
            // --- RESET PREPAYMENT STATE ---
            document.getElementById('prepayment-type').value = 'none';
            document.getElementById('prepayment-amount').value = '0';
            customPayments = []; // Clear custom payments array
            renderCustomPaymentsList(); // Clear UI list
            updatePrepaymentInputs(); // Reset UI visibility
            // -----------------------------

            const monthlyRate = (ratePercent / 100) / 12;
            const tenureMonths = Math.round(tenureYears * 12);
            const maxMonths = 300; // Max 25 years * 12 months, using a safer limit for initial calculation
            
            // Store initial values globally
            initialPrincipal = principal;
            initialRate = ratePercent;
            initialTenureMonths = tenureMonths;
            loanStartDateString = startDateString; // Store the start date

            // Calculate Initial EMI and round it to the nearest Rupee
            const rawEmi = calculateEMI(principal, monthlyRate, tenureMonths);
            const emi = roundToRupee(rawEmi);
            initialEMI = emi;

            // Generate the baseline schedule (without prepayments)
            const result = generateAmortizationSchedule(principal, monthlyRate, emi, maxMonths);
            
            // Check for calculation errors
            if (result.schedule.length === 0 && principal > 0) return;Â 

            initialTotalInterest = result.totalInterest;
            initialTotalPayments = result.totalPayments;

            // Display Summary
            document.getElementById('initial-emi-output').textContent = CURRENCY_FORMAT.format(emi);
            document.getElementById('initial-interest-output').textContent = CURRENCY_FORMAT.format(initialTotalInterest);
            document.getElementById('original-duration-output').textContent = `${tenureYears} Years (${initialTotalPayments} Months)`;
            
            document.getElementById('summary-section').classList.remove('hidden');
            document.getElementById('prepayment-container').classList.remove('hidden');
            document.getElementById('schedule-section').classList.remove('hidden');
            document.getElementById('savings-summary').classList.add('hidden'); // Hide savings initially
            
            // Render the initial schedule
            renderSchedule(result.schedule, startDateString);

            // Update custom payment list placeholder after loan is calculated
            if (customPayments.length === 0) {
                 document.getElementById('custom-payments-placeholder').textContent = 'No custom payments added yet.';
            }
        }

        /**
         * Handles the prepayment input, recalculates the loan, and updates the display.
         */
        function applyPrepayments() {
            const monthlyRate = (initialRate / 100) / 12;
            const prepaymentType = document.getElementById('prepayment-type').value;
            const reductionOption = document.getElementById('reduction-option').value;
            const startDateString = loanStartDateString; // Use the stored start date
            const maxMonths = 300 * 3;Â // A sufficiently high number of months to ensure completion

            if (!startDateString || initialPrincipal === 0) {
                 showMessage('Missing Data', 'Please click "Proceed" first to calculate the initial loan details.', 'error');
                 return;
            }


            // 1. Parse Prepayments Map
            let prepaymentsMap = {};
            let prepaymentAmount = 0;
            let totalPrepaymentAmount = 0;

            if (prepaymentType === 'custom') {
                if (customPayments.length === 0) {
                     showMessage('Prepayment Error', 'Please add custom prepayments using the date and amount fields above.', 'error');
                     return;
                }
                customPayments.forEach(p => {
                    prepaymentsMap[p.monthIndex] = (prepaymentsMap[p.monthIndex] || 0) + p.amount;
                });
            } else if (prepaymentType !== 'none') {
                prepaymentAmount = parseFloat(document.getElementById('prepayment-amount').value);
                
                if (prepaymentAmount <= 0 || isNaN(prepaymentAmount)) {
                    showMessage('Prepayment Error', `Please enter a valid positive amount for ${prepaymentType} prepayment.`, 'error');
                    return;
                }
                // Round input amount before using it for calculation
                prepaymentAmount = roundToRupee(prepaymentAmount);

                if (prepaymentType === 'one-time') {
                    // Check for the dynamically created selectors
                    const monthInput = document.getElementById('one-time-month-input');
                    const yearInput = document.getElementById('one-time-year-input');

                    if (!monthInput || !yearInput) {
                        showMessage('Prepayment Error', 'One-time date selectors are missing. Please ensure you have calculated the loan and selected the date.', 'error');
                        return;
                    }

                    const oneTimeDate = `${yearInput.value}-${monthInput.value}`;
                    
                    if (!oneTimeDate) {
                          showMessage('Prepayment Error', 'Please select a Month and Year for the one-time payment.', 'error');
                          return;
                    }
                    
                    const oneTimeMonth = getMonthIndexFromDate(oneTimeDate, loanStartDateString); // Convert to index
                    
                    if (oneTimeMonth < 1) {
                        showMessage('Date Error', 'The one-time payment date must be in or after the loan start month.', 'error');
                        return;
                    }
                    
                    prepaymentsMap[oneTimeMonth] = prepaymentAmount;

                } else {
                    // Regular prepayments
                    const interval = {
                        'monthly': 1,
                        'quarterly': 3,
                        'six-monthly': 6,
                        'yearly': 12
                    }[prepaymentType];
                    
                    if (interval) {
                        for (let i = interval; i <= initialTenureMonths; i += interval) {
                            prepaymentsMap[i] = prepaymentAmount;
                        }
                    }
                }
            }

            // Fallback: If no prepayments are applied, show initial schedule and hide savings
            if (Object.keys(prepaymentsMap).length === 0) {
                calculateLoan(); // Recalculate and render the initial state (already resets state)
                return;
            }

            // 2. Initial Run (Tenure Reduction Basis): Runs with initial EMI + all prepayments
            const initialPrepaymentRun = generateAmortizationSchedule(initialPrincipal, monthlyRate, initialEMI, maxMonths, prepaymentsMap);
            
            if (initialPrepaymentRun.schedule.length === 0 && initialPrincipal > 0) return;Â // Error was shown inside schedule function

            // Recalculate total prepayment amount actually made (in case loan paid off early)
            totalPrepaymentAmount = initialPrepaymentRun.schedule.reduce((sum, item) => sum + item.prepayment, 0);

            let newEMI = initialEMI;
            let newResult;
            let newEmiInfoText = '';
            let M_recalc = 9999; // Month index where the new EMI starts

            
            // 3. Recalculation based on Reduction Option
            if (reductionOption === 'tenure') {
                // If tenure is reduced, we use the results from the initial prepayment run directly.
                newResult = initialPrepaymentRun;
                newEMI = initialEMI; // EMI stays the same
                newEmiInfoText = `Your Monthly EMI remained at ${CURRENCY_FORMAT.format(initialEMI)}.`;
                
            } else if (reductionOption === 'emi') {
                
                // 3a. Determine Recalculation Month (M_recalc) - Month AFTER last prepayment
                let lastPrepaymentMonth = 0;
                if (Object.keys(prepaymentsMap).length > 0) {
                    lastPrepaymentMonth = Math.max(...Object.keys(prepaymentsMap).map(Number));
                }
                M_recalc = lastPrepaymentMonth > 0 ? lastPrepaymentMonth + 1 : 1;Â 
                
                // 3b. Determine Outstanding Principal (pRecalc)
                const lastProcessedMonthIndex = M_recalc - 1;
                let pRecalc = initialPrincipal; // Default to initial principal if M_recalc is 1
                
                const lastProcessedEntry = initialPrepaymentRun.schedule.find(item => item.month === lastProcessedMonthIndex);
                
                if (lastProcessedEntry) {
                    pRecalc = lastProcessedEntry.outstanding;
                } else if (lastProcessedMonthIndex > 0 && initialPrepaymentRun.schedule.length > 0) {
                    // This handles scenarios where the payment schedule is short (loan paid off early)
                    pRecalc = initialPrepaymentRun.schedule[initialPrepaymentRun.schedule.length - 1].outstanding;
                }
                
                // Check if loan is already paid off before the new EMI can kick in
                if (pRecalc <= 0) {
                    newEMI = 0;
                    newResult = initialPrepaymentRun;
                    const lastPaidMonth = initialPrepaymentRun.schedule.length;
                    // FIX: Removed bolding/stars
                    newEmiInfoText = `The loan was paid off early in month ${lastPaidMonth} even with the original EMI. New EMI is not applicable.`;
                    
                } else {

                    // 3c. Calculate New EMI
                    const N_remaining = initialTotalPayments - lastProcessedMonthIndex; // Remaining months based on ORIGINAL tenure

                    if (N_remaining > 0) {
                        // Calculate New EMI based on the reduced principal over the *original remaining tenure*.
                        const rawNewEmi = calculateEMI(pRecalc, monthlyRate, N_remaining);
                        newEMI = roundToRupee(rawNewEmi);
                    } else {
                        newEMI = 0;
                    }
                    
                    // 3d. Create the Final Schedule for EMI Reduction
                    // Part 1: All payments before the new EMI starts (M_recalc - 1 month is processed)
                    let schedulePart1 = initialPrepaymentRun.schedule.filter(item => item.month < M_recalc);
                    
                    // Part 2: Payments from M_recalc onwards using the NEW EMI
                    const remainingPrepayments = {};
                    for (const monthIndex in prepaymentsMap) {
                        if (Number(monthIndex) >= M_recalc) {
                            remainingPrepayments[monthIndex] = prepaymentsMap[monthIndex];
                        }
                    }
                    
                    // The EMI reduction schedule should aim for the original term's remaining months.
                    const maxMonthsPart2 = N_remaining;

                    // Generate Part 2 starting with the new principal and new EMI
                    const resultPart2 = generateAmortizationSchedule(pRecalc, monthlyRate, newEMI, maxMonthsPart2, remainingPrepayments);
                    
                    // Correct the month index in Part 2's schedule
                    const schedulePart2 = resultPart2.schedule.map(item => ({
                        ...item,
                        month: item.month + lastProcessedMonthIndex,
                        // Update the EMI value in the item for the renderer to display the new EMI correctly
                        emi: newEMI 
                    }));

                    // 3e. Combine Results
                    let combinedSchedule = [...schedulePart1, ...schedulePart2];
                    
                    // FIX: Ensure the combined schedule runs up to the original term (initialTotalPayments)
                    // This is key for the EMI reduction duration to match the original loan term.
                    const finalMonthOfOriginalLoan = initialTotalPayments;
                    let lastMonthInCombined = combinedSchedule.length;
                    
                    // Append zero-payment rows if loan paid off early but option is EMI reduction
                    while (lastMonthInCombined < finalMonthOfOriginalLoan) {
                        lastMonthInCombined++;
                        // Add zero-balance rows until the original end date is reached
                        combinedSchedule.push({
                            month: lastMonthInCombined, 
                            emi: newEMI, // The EMI rate is technically still active but payments are zero
                            prepayment: 0, 
                            principal: 0,Â 
                            interest: 0, 
                            outstanding: 0, 
                            isPrepaymentMonth: false,
                        });
                    }

                    // Recalculate total interest from combined schedule (Part 1 + Part 2)
                    const combinedTotalInterest = combinedSchedule.reduce((sum, item) => sum + item.interest, 0);


                    newResult = {
                        schedule: combinedSchedule,
                        totalInterest: combinedTotalInterest, 
                        totalPayments: combinedSchedule.length // Use the enforced length
                    };

                    // Final info text with Month and Year
                    if (newEMI > 0) {
                        const recalcDateDisplay = getDateForMonth(M_recalc, loanStartDateString);
                        // FIX: Removed bolding/stars and month index from the main message
                        newEmiInfoText = `Your new Monthly EMI will be ${CURRENCY_FORMAT.format(newEMI)} starting from ${recalcDateDisplay} of the loan.`;
                        
                        // Indicate if the loan was still technically paid off early (before the original end date)
                        if (resultPart2.schedule.length < maxMonthsPart2) {
                            const actualPaidOffMonth = schedulePart1.length + resultPart2.schedule.length;
                            // FIX: Removed bolding/stars
                            newEmiInfoText += ` Note: The loan was physically paid off early in month ${actualPaidOffMonth}. EMI payments stop then.`;
                        }
                    } else {
                        // FIX: Removed bolding/stars
                        newEmiInfoText = `The loan was paid off early in month ${schedulePart1.length} even with the original EMI.`;
                    }
                }

            } // End of reductionOption === 'emi'

            // 4. Calculate Final Savings
            // Use the calculated total interest from the new result (which includes Part 1 + Part 2 where applicable)
            const newTotalInterest = newResult.totalInterest;
            const interestSaved = initialTotalInterest - newTotalInterest;
            
            // Calculate tenure reduction based on actual payment count (only count months with actual payments)
            const actualPaymentCount = newResult.schedule.filter(item => item.principal > 0 || item.interest > 0 || item.prepayment > 0).length;
            
            // For the EMI reduction option, we show the original duration, but the reduction based on actual payments
            const totalPaymentsToDisplay = reductionOption === 'emi' ? initialTotalPayments : newResult.totalPayments;
            
            const tenureReductionMonths = initialTotalPayments - actualPaymentCount;

            // 5. Display Savings Summary
            document.getElementById('saved-interest-output').textContent = CURRENCY_FORMAT.format(interestSaved);
            document.getElementById('new-duration-output').textContent = `${Math.floor(totalPaymentsToDisplay / 12)}Y ${totalPaymentsToDisplay % 12}M (${totalPaymentsToDisplay} Months)`;
            
            // For 'emi' reduction, display the number of months cut from the full term.
            const tenureReductionText = reductionOption === 'emi' ? 
                `${Math.floor(tenureReductionMonths / 12)}Y ${tenureReductionMonths % 12}M (EMI Reduction Goal)` :
                `${Math.floor(tenureReductionMonths / 12)}Y ${tenureReductionMonths % 12}M`;

            document.getElementById('tenure-reduction-output').textContent = tenureReductionText;
            
            newEmiInfoText += ` Total Prepayment made: ${CURRENCY_FORMAT.format(totalPrepaymentAmount)}.`;
            document.getElementById('new-emi-info').innerHTML = newEmiInfoText;


            document.getElementById('savings-summary').classList.remove('hidden');

            // 6. Render the Final Schedule
            renderSchedule(newResult.schedule, startDateString, newEMI, M_recalc);
        }
        
        /**
         * Renders the amortization schedule table.
         * @param {Array} schedule - The amortization schedule array.
         * @param {string} startDateString - Loan start month string.
         * @param {number} [currentEMI=initialEMI] - The EMI used for the schedule display (used for the NEW EMI value).
         * @param {number} [recalcMonth=9999] - The month the new EMI starts (used to trigger formatting).
         */
        function renderSchedule(schedule, startDateString, currentEMI = initialEMI, recalcMonth = 9999) {
            const tbody = document.getElementById('schedule-body');
            tbody.innerHTML = '';
            
            const initialEMIValue = initialEMI;

            schedule.forEach(item => {
                const row = tbody.insertRow();
                
                // Determine the EMI to display for this row
                let displayEMI = item.emi;
                
                // Determine actual total payment for last month
                if (item.outstanding <= 0 && item.month === schedule.length) {
                     // Last residual payment
                     displayEMI = item.principal + item.interest + item.prepayment;
                } else if (item.outstanding <= 0 && item.month < schedule.length) {
                    // Loan paid off early, remaining rows should show 0 payment if it's past the last actual payment month
                    displayEMI = 0;
                } else if (item.month >= recalcMonth) {
                    // Use the new EMI for all rows from the recalc month onwards if the loan is still active
                    displayEMI = currentEMI;
                } else {
                    // Use the initial EMI before the recalc month
                    displayEMI = initialEMIValue;
                }
                
                // Format for EMI change indication
                const emiFormat = (value) => {
                    const formatted = CURRENCY_FORMAT.format(value);
                    // Check if the current month is the month where the new EMI starts AND EMI has changed substantially
                    if (item.month >= recalcMonth && Math.abs(currentEMI - initialEMIValue) > 1 && value > 0) {
                        // Check if this month is the start of the new EMI and the new EMI is different from the original EMI
                        if (item.month === recalcMonth) {
                             return `<span class="font-bold text-red-600">${formatted} (New)</span>`;
                        } else if (item.month > recalcMonth) {
                             // Use the new EMI text color for all subsequent payments if EMI has changed
                             return `<span class="font-bold text-red-600">${formatted}</span>`;
                        }
                    }
                    return formatted;
                };
                
                // Styling for paid-off month
                if (item.outstanding <= 0 && item.month === schedule.length) {
                    row.classList.add('bg-green-100', 'font-bold');
                } else if (item.isPrepaymentMonth) {
                    row.classList.add('bg-yellow-100');
                }

                row.innerHTML = `
                    <td class="table-cell">${item.month}</td>
                    <td class="table-cell whitespace-nowrap">${getDateForMonth(item.month, startDateString)}</td>
                    <td class="table-cell">${emiFormat(displayEMI)}</td>
                    <td class="table-cell ${item.prepayment > 0 ? 'font-bold text-blue-600' : 'text-gray-400'}">${CURRENCY_FORMAT.format(item.prepayment)}</td>
                    <td class="table-cell">${CURRENCY_FORMAT.format(item.principal)}</td>
                    <td class="table-cell">${CURRENCY_FORMAT.format(item.interest)}</td>
                    <td class="table-cell ${item.outstanding <= 0 ? 'text-green-700 font-extrabold' : ''}">${CURRENCY_FORMAT.format(item.outstanding)}</td>
                `;
            });
        }
        
        /**
         * Populates the month and year select inputs.
         * @param {HTMLElement} monthSelect - The month select element.
         * @param {HTMLElement} yearSelect - The year select element.
         */
        function populateMonthYearSelects(monthSelect, yearSelect) {
            const months = [
                { value: '01', name: 'Jan' }, { value: '02', name: 'Feb' }, { value: '03', name: 'Mar' },
                { value: '04', name: 'Apr' }, { value: '05', name: 'May' }, { value: '06', name: 'Jun' },
                { value: '07', name: 'Jul' }, { value: '08', name: 'Aug' }, { value: '09', name: 'Sep' },
                { value: '10', name: 'Oct' }, { value: '11', name: 'Nov' }, { value: '12', name: 'Dec' }
            ];

            // Clear existing options
            monthSelect.innerHTML = '';
            yearSelect.innerHTML = '';

            // Populate months
            months.forEach(month => {
                const option = document.createElement('option');
                option.value = month.value;
                option.textContent = month.name;
                monthSelect.appendChild(option);
            });

            // Populate years (Current Year +/- 25 years)
            const currentYear = new Date().getFullYear();
            const startYear = currentYear - 25;
            const endYear = currentYear + 25;

            for (let year = startYear; year <= endYear; year++) {
                const option = document.createElement('option');
                option.value = year;
                option.textContent = year;
                yearSelect.appendChild(option);
            }
            
            // Set current month/year as default
            const currentMonth = String(new Date().getMonth() + 1).padStart(2, '0');
            monthSelect.value = currentMonth;
            yearSelect.value = currentYear;
        }


        // --- Initialization ---

        window.onload = function() {
            // Populate all static date selectors (Loan Start, Custom Prepayment)
            populateMonthYearSelects(document.getElementById('start-month'), document.getElementById('start-year'));
            populateMonthYearSelects(document.getElementById('custom-payment-month'), document.getElementById('custom-payment-year'));
            
            // Set the default date for Custom Prepayment to match Loan Start Month default
            document.getElementById('custom-payment-month').value = document.getElementById('start-month').value;
            document.getElementById('custom-payment-year').value = document.getElementById('start-year').value;

            // Initialize prepayment options based on default reduction selection
            updatePrepaymentOptions();
        }
        
        // Add styling for input fields and table cells using JavaScript (as Tailwind classes cannot be used in `style` block for components)
        document.head.insertAdjacentHTML('beforeend', `
            <style>
                .input-field {
                    /* Original input-field for select/non-grouped items */
                    @apply w-full p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 transition duration-150;
                }
                .summary-card {
                    @apply p-4 rounded-xl shadow-md border;
                }
                .table-header {
                    @apply px-4 py-3 text-left text-xs font-medium text-gray-700 uppercase tracking-wider;
                }
                .table-cell {
                    @apply px-4 py-3 whitespace-nowrap text-right;
                }
                .table-cell:first-child {
                    @apply text-center;
                }
                
                /* Adjust custom input groups in the prepayment section */
                #custom-months-div .input-field {
                    /* Ensure inputs in the custom prepayment grid use standard styling */
                    @apply w-full p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 transition duration-150;
                }
            </style>
        `);

    </script>
</body>
</html>
